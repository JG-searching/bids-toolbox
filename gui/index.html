<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="gui/brain_icon.ico">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>The BIDS Toolbox</title>

    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="gui/template.css" rel="stylesheet">

  </head>

  <body>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"</script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>

<!-- Dynamic table from: https://bootsnipp.com/snippets/402bQ -->

	<script>

	$(document).ready(function () {

	    //$("#mainHeader").hide();
	    $("#createForm").hide();
	    $("#updateForm").hide();
	    $("#waitCreationLabel").hide();
	    $("#successCreationLabel").hide();
	    $("#waitUpdateLabel").hide();
	    $("#successUpdateLabel").hide();

	    $('input[type="radio"]').click(function(){
		var inputValue = $(this).attr("value");

		if (inputValue == "create")
		{
	    		$("#updateForm").hide();
			$("#createForm").show();
		}
		else
		{
			$("#createForm").hide();
	    		$("#updateForm").show();
		}
	    });

	    var dicom_c_counter = 0; //Number of rows in the createDataset, DICOM folders table
	    var desc_c_counter = 0; //Number of rows in the createDataset, dataset-description table
	    var scan_counter = 0; //Number of rows in the createDataset, scan-types table

	    var desc_u_counter = 0; //Number of rows in the updateDataset, dataset-description table
	    var dicom_u_counter = 0; //Number of rows in the updateDataset, DICOM folders table

	    $("#dicom_create_addrow").on("click", function () {
		var newRow = $("<tr>");
		var cols = "";

		cols += '<td><input type="number" size="5" min="1" name="dicom_sub_create'+dicom_c_counter+'" class="input-sm form-control" /></td>';
		cols += '<td><input type="number" size="5" min="1" name="dicom_ses_create'+dicom_c_counter+'"  class="input-sm form-control"/></td>';
		cols += '<td><input type="text" name="dicom_path_create'+dicom_c_counter+'" class="input-sm form-control"/></td>';
		cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';

		newRow.append(cols);
		$("#dicom_create_table").append(newRow);
		dicom_c_counter++;
	    });

	    $("#dicom_create_table").on("click", ".ibtnDel", function (event) {
		$(this).closest("tr").remove();       
		dicom_c_counter -= 1
	    });

	    $("#dicom_update_addrow").on("click", function () {
		var newRow = $("<tr>");
		var cols = "";

		cols += '<td><input type="number" size="5" min="1" name="dicom_sub_update'+dicom_u_counter+'" class="input-sm form-control" /></td>';
		cols += '<td><input type="number" size="5" min="1" name="dicom_ses_update'+dicom_u_counter+'"  class="input-sm form-control"/></td>';
		cols += '<td><input type="text" name="dicom_path_update'+dicom_u_counter+'" class="input-sm form-control"/></td>';
		cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';

		newRow.append(cols);
		$("#dicom_update_table").append(newRow);
		dicom_u_counter++;
	    });

	    $("#dicom_update_table").on("click", ".ibtnDel", function (event) {
		$(this).closest("tr").remove();       
		dicom_u_counter -= 1
	    });



	    $("#scan_addrow").on("click", function () {
		var newRow = $("<tr>");
		var cols = "";

		cols += '<td><input type="text" class="form-control" name="scan_name' + scan_counter + '"/></td>';
		cols += '<td> <select id="scan_type' + scan_counter + '" class="form-control"> <option selected>func</option> <option>dwi</option> <option>fmap</option> <option>anat</option> <option>meg</option> </select> </td>';
		cols += '<td><input type="text" class="form-control" name="scan_type' + scan_counter + '"/></td>';

		cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';
		newRow.append(cols);
		$("#scan_types_table").append(newRow);
		scan_counter++;
	    });

	    $("#scan_types_table").on("click", ".ibtnDel", function (event) {
		$(this).closest("tr").remove();       
		scan_counter -= 1
	    });

	    $("#desc_create_addrow").on("click", function () {
		var newRow = $("<tr>");
		var cols = "";

		cols += '<td><input type="text" class="input-sm form-control" name="desc_key' + desc_c_counter + '"/></td>';
		cols += '<td><input type="text" class="input-sm form-control" name="desc_value' + desc_c_counter + '"/></td>';

		cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';
		newRow.append(cols);
		$("#desc_create_table").append(newRow);
		desc_c_counter++;
	    });

	    $("#desc_create_table").on("click", ".ibtnDel", function (event) {
		$(this).closest("tr").remove();       
		desc_c_counter -= 1
	    });

	    $("#desc_update_addrow").on("click", function () {
		var newRow = $("<tr>");
		var cols = "";

		cols += '<td><input type="text" class="input-sm form-control" name="desc_key' + desc_u_counter + '"/></td>';
		cols += '<td><input type="text" class="input-sm form-control" name="desc_value' + desc_u_counter + '"/></td>';

		cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';
		newRow.append(cols);
		$("#desc_update_table").append(newRow);
		desc_u_counter++;
	    });

	    $("#desc_update_table").on("click", ".ibtnDel", function (event) {
		$(this).closest("tr").remove();       
		desc_u_counter -= 1
	    });

            $("#createButton").click(function(){
	
		var message = new Object();
		message["scans"] = {}
		message["metadata"] = {}
		message["metadata"]["modalities"] = []
		message["metadata"]["datasetDescription"] = {}

		$("#dicom_create_table > tbody > tr").each(function(){
			var sub = $(this).find('input[name^="dicom_sub_create"]').val();
			if((sub in message["scans"]) == false)
			{
				message["scans"][sub] = {};
			}
			var ses = $(this).find('input[name^="dicom_ses_create"]').val();
			var path = $(this).find('input[name^="dicom_path_create"]').val();
			message["scans"][sub][ses] = path;
		});

		message["output"] = $("#output_folder_create").val();

		$("#desc_create_table > tbody > tr").each(function(){
			var key = $(this).find('input[name^="desc_key"]').val();
			var kvalue = $(this).find('input[name^="desc_value"]').val();
	
			message["metadata"]["datasetDescription"][key] = kvalue;
		});	
	
		$("#scan_types_table > tbody > tr").each(function(){
			var sKey = $(this).find('input[name^="scan_name"]').val();
			var sType = $(this).find('select[id^="scan_type"]').val();
			var sMod = $(this).find('input[name^="scan_type"]').val();

			message["metadata"]["modalities"].push({"tag":sKey, "type":sType, "modality":sMod});
		});	
		
	    	$("#mainHeader").hide();
		$("#createForm").hide();
		$("#updateForm").hide();
		$("#waitCreationLabel").show();

		$.ajax({
			url:"/createBids",
			type:"POST",
			data:JSON.stringify(message),
			contentType:"application/json",
			dataType:"json",
			//success: function(){
			//	alert("Conversion finished");
			//},
			complete: function(){
				//alert("Complete function");
				$("#waitCreationLabel").hide();
				$("#successCreationLabel").show();
			}
		})		

            });

            $("#updateButton").click(function(){

		var message = new Object();
		message["scans"] = {}
		message["metadata"] = {}
		message["metadata"]["datasetDescription"] = {}

		$("#dicom_update_table > tbody > tr").each(function(){
			var sub = $(this).find('input[name^="dicom_sub_update"]').val();
			if((sub in message["scans"]) == false)
			{
				message["scans"][sub] = {};
			}
			var ses = $(this).find('input[name^="dicom_ses_update"]').val();
			var path = $(this).find('input[name^="dicom_path_update"]').val();
			message["scans"][sub][ses] = path;
		});

		message["output"] = $("#output_folder_update").val();

		$("#desc_update_table > tbody > tr").each(function(){
			var key = $(this).find('input[name^="desc_key"]').val();
			var kvalue = $(this).find('input[name^="desc_value"]').val();
	
			message["metadata"]["datasetDescription"][key] = kvalue;
		});	
		
	    	$("#mainHeader").hide();
		$("#createForm").hide();
		$("#updateForm").hide();
		$("#waitUpdateLabel").show();

		$.ajax({
			url:"/updateBids",
			type:"POST",
			data:JSON.stringify(message),
			contentType:"application/json",
			dataType:"json",
			//success: function(){
			//	alert("Conversion finished");
			//},
			complete: function(){
				//alert("Complete function");
				$("#waitUpdateLabel").hide();
				$("#successUpdateLabel").show();
			}
		})		
            });


            $("#checkDatasetButton").click(function(){

		var message = new Object();
		message["folder"] = $("#output_folder_update").val();

		$.ajax({
			url:"/checkDataset",
			type:"POST",
			data:JSON.stringify(message),
			contentType:"application/json",
			dataType:"json",
			success: function(response){
				var valid = response['valid'];
				if (valid == 'yes')
				{	//Write number of subjects in dataset and enable button
					$("#checkResult").text("All good, dataset has "+response['subjects']+" subjects");
					$("#updateButton").prop('disabled',false)
				}
				else
				{	//Write error in div next to button
					$("#checkResult").text("Error: "+response['error']);
				}
			},
			complete: function(data){
			}
		})		
	    });

	});

	function calculateRow(row) {
	    var price = +row.find('input[name^="price"]').val();
	}

	function calculateGrandTotal() {
	    var grandTotal = 0;
	    $("table.order-list").find('input[name^="price"]').each(function () {
		grandTotal += +$(this).val();
	    });
	    $("#grandtotal").text(grandTotal.toFixed(2));
	}
	</script>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top"> 
      <a class="navbar-brand" href="https://www.cardiff.ac.uk/cardiff-university-brain-research-imaging-centre">Cardiff University Brain Research Imaging Centre (CUBRIC)</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      </button>
    </nav>

    <main role="main" class="container">

      <div class="starter-template">
    	<img src="gui/brain_logo.png" class="img-rounded" alt="Brain logo here" height="60" width="60" > 
        <h1>The BIDS Toolbox</h1>

	<div  id="mainHeader"> 
        <p  class="lead">
	 Use this tool to create and manage Brain Imaging Data Structure (BIDS) datasets.<br>
	 Choose between the options below to start. Learn more about BIDS <a href="http://bids.neuroimaging.io">here</a>. 
	</p>
	I want to:
	<div class="form-check form-check-inline">
	  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="create">
	  <label class="form-check-label" for="inlineRadio1">create a new dataset</label>
	</div>
	<div class="form-check form-check-inline">
	  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="update">
	  <label class="form-check-label" for="inlineRadio2">update an existing dataset</label>
	</div>
	</div>

      </div>

	<form id="createForm">
	A BIDS dataset is created from a set of DICOM files and some additional descriptive metadata. Follow the steps below to provide the required information for the creation of your dataset.<br><br>

	    <p style="text-align:justify"><b>First:</b> Type the full path of the folders containing the DICOM files for each of sessions. In Linux, e.g., this could be similar to <i>/home&#173;/james&#173;/ ... /DICOMs&#173;/Sub01&#173;/Ses01</i> for the folder containing the DICOM files of subject 1, session 1. This step is <u>obligatory</u>:</p>

	<div class="container">
	    <table id="dicom_create_table" class=" table order-list">
	    <thead>
		<tr>
		    <td>Subject ID</td>
		    <td>Session ID</td>
		    <td>Folder containing DICOM files</td>
		</tr>
	    </thead>
	    <tbody>
		<tr>
		    <td>
			<input type="number" size="5" min="1" value="1" name="dicom_sub_create" class="input-sm form-control" />
		    </td>
		    <td>
			<input type="number" size="5" min="1" value="1" name="dicom_ses_create"  class="input-sm form-control"/>
		    </td>
		    <td>
			<input type="text" name="dicom_path_create"  class="input-sm form-control"/>
		    </td>

		    <td><a class="deleteRow"></a>
		    </td>
		</tr>
	    </tbody>
	    <tfoot>
		<tr>
		    <td colspan="5" style="text-align: left;">
			<input type="button" class="btn btn-lg btn-block " id="dicom_create_addrow" value="Add session" />
		    </td>
		</tr>
		<tr>
		</tr>
	    </tfoot>
	</table>
	</div>

	  <div class="form-group">
	    <p style="text-align:justify" ><b>Second:</b> Type the full path to the folder where you want to store the BIDS dataset. In Linux, e.g., this could be similar to <i>/home&#173;/james&#173;/Documents&#173;/BIDSdataset</i>. This step is <u>obligatory</u>:</p>
	    <input type="text" id="output_folder_create" class="input-sm form-control" required/>
	  </div>

	<p style="text-align:justify"><b>Third:</b> BIDS datasets include a mandatory <i>dataset_description.json</i> file which describe their content. This file is arranged in key-value pairs and you should add to the following table those that you want to be added to your <i>dataset_description.json</i> file. This step is <u>optional</u>.</p>

	<div class="container">
	    <table id="desc_create_table" class=" table order-list">
	    <thead>
		<tr>
		    <td>Key</td>
		    <td>Value</td>
		</tr>
	    </thead>
	    <tbody>
		<tr>
		    <td>
			<input type="text" name="desc_key" class="input-sm form-control" />
		    </td>
		    <td>
			<input type="text" name="desc_value"  class="input-sm form-control"/>
		    </td>
		    <td><a class="deleteRow"></a>

		    </td>
		</tr>
	    </tbody>
	    <tfoot>
		<tr>
		    <td colspan="5" style="text-align: left;">
			<input type="button" class="btn btn-lg btn-block " id="desc_create_addrow" value="Add dataset description item" />
		    </td>
		</tr>
		<tr>
		</tr>
	    </tfoot>
	</table>
	</div>

	<p style="text-align:justify"><b>Fourth:</b> During the creation of the BIDS dataset, the Toolbox will create a set of Nifti files based on the DICOM files you provide. However, the DICOM files don't declare explicitly the type of acquisition (whether the scan is structural, diffusion,... ) and knowing so is mandatory for the creation of the dataset. The Toolbox includes a heuristic to infer the type of scan based on several parameters of the DICOM headers, but it is not 100% accurate. If you know these values, you can define the type of scan for each of the series in the following fields. This step is <u>optional</u>.</p>

	<div class="container">
	    <table id="scan_types_table" class=" table order-list">
	    <thead>
		<tr>
		    <td>Name</td>
		    <td>Scan modality</td>
		    <td>Scan type</td>
		</tr>
	    </thead>
	    <tbody>
		<tr>
		    <td>
			<input type="text" name="scan_name" class="input-sm form-control" />
		    </td>
		    <td>
		      <select id="scan_type" class="form-control">
			<option selected>func</option>
			<option>dwi</option>
			<option>fmap</option>
			<option>anat</option>
			<option>meg</option>
		      </select>
		    </td>
		    <td>
			<input type="text" name="scan_type"  class="input-sm form-control"/>
		    </td>
		    <td><a class="deleteRow"></a>

		    </td>
		</tr>
	    </tbody>
	    <tfoot>
		<tr>
		    <td colspan="5" style="text-align: left;">
			<input type="button" class="btn btn-lg btn-block " id="scan_addrow" value="Add scan modality/type" />
		    </td>
		</tr>
		<tr>
		</tr>
	    </tfoot>
	</table>
	</div>

	And that's it. Check that all the values you've entered look good and click the button below to start. <br><br>

	  <button type="button" id="createButton" class="btn btn-primary">Create dataset</button>
	</form>


	<form id="updateForm">
	This section is used to append brain imaging files to an existing BIDS dataset created with this toolbox. Follow the steps below to provide the required information: <br><br>	

	  <div class="form-group">
	    <p style="text-align:justify" ><b>First:</b> Type the full path to the folder of the BIDS dataset to be updated. In Linux, e.g., this could be similar to <i>/home&#173;/james&#173;/ ... /BIDSdataset</i>. This step is <u>obligatory</u>:</p>
	    <input type="text" id="output_folder_update" class="input-sm form-control" required/>
	    <br>
	    <p style="text-align:justify" >After typing the full path to the dataset, press the <i>Check dataset</i> below to check that the folder is correct.</p>
	  <button type="button" id="checkDatasetButton" class="btn btn-primary">Check dataset</button>
	  <div id="checkResultPadding" style="display: inline-block">      </div>
	  <div id="checkResult" style="display: inline-block"></div>
	  <br>
	  </div>

	    <p style="text-align:justify"><b>Second:</b> Type the full path of the folders containing the DICOM files for the new sessions. This step is <u>obligatory</u>:</p>

	<div class="container">
	    <table id="dicom_update_table" class=" table order-list">
	    <thead>
		<tr>
		    <td>Subject ID</td>
		    <td>Session ID</td>
		    <td>Folder containing DICOM files</td>
		</tr>
	    </thead>
	    <tbody>
		<tr>
		    <td>
			<input type="number" size="5" min="1" value="1" name="dicom_sub_update" class="input-sm form-control" />
		    </td>
		    <td>
			<input type="number" size="5" min="1" value="1" name="dicom_ses_update"  class="input-sm form-control"/>
		    </td>
		    <td>
			<input type="text" name="dicom_path_update"  class="input-sm form-control"/>
		    </td>

		    <td><a class="deleteRow"></a>
		    </td>
		</tr>
	    </tbody>
	    <tfoot>
		<tr>
		    <td colspan="5" style="text-align: left;">
			<input type="button" class="btn btn-lg btn-block " id="dicom_update_addrow" value="Add session" />
		    </td>
		</tr>
		<tr>
		</tr>
	    </tfoot>
	</table>
	</div>

	<b>Third:</b> Use the following table to append/modify key-value pairs to the <i>dataset_description.json</i> file of the dataset. This step is <u>optional</u>.<br><br>

	<div class="container">
	    <table id="desc_update_table" class=" table order-list">
	    <thead>
		<tr>
		    <td>Key</td>
		    <td>Value</td>
		</tr>
	    </thead>
	    <tbody>
		<tr>
		    <td>
			<input type="text" name="desc_key" class="input-sm form-control" />
		    </td>
		    <td>
			<input type="text" name="desc_value"  class="input-sm form-control"/>
		    </td>
		    <td><a class="deleteRow"></a>

		    </td>
		</tr>
	    </tbody>
	    <tfoot>
		<tr>
		    <td colspan="5" style="text-align: left;">
			<input type="button" class="btn btn-lg btn-block " id="desc_update_addrow" value="Add dataset description item" />
		    </td>
		</tr>
		<tr>
		</tr>
	    </tfoot>
	</table>
	</div>

	That's it. Check that all the values you've entered look good and click the button below to update your dataset. <br><br>

	  <button type="button" id="updateButton" class="btn btn-primary" disabled>Update dataset</button>

	</form>	

      	<div class="starter-template">
         <p id="waitCreationLabel" class="lead">
	 Please, wait while your BIDS dataset is being created...<br>
	 </p>
         <p id="successCreationLabel" class="lead">
	 Creation finished. Your dataset is now available in the specified output folder.<br>
	 </p>
         <p id="waitUpdateLabel" class="lead">
	 Please, wait while your BIDS dataset is being updated...<br>
	 </p>
         <p id="successUpdateLabel" class="lead">
	 Update finished. Your dataset is now available in the specified output folder.<br>
	 </p>
	</div>

	<br><br>
	<small>
	The BIDS Toolbox is part of the <i>Microstructural Imaging Data Centre (MIDaC)</i> project, grant reference ST/S00209X/1, funded by the Science and Technology Facilities Council (STFC) of the UK.  
	</small>
	<br><br>

    </main><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://getbootstrap.com/docs/4.0/assets/js/vendor/popper.min.js"></script>
    <script src="https://getbootstrap.com/docs/4.0/dist/js/bootstrap.min.js"></script>
  </body>
</html>

